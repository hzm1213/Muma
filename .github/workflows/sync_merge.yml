name: Sync, Rename and Merge Muma

on:
  schedule:
    - cron: '0 */6 * * *'  # 每6小时运行一次
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync_and_merge:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout self repository
        uses: actions/checkout@v4

      - name: Set up Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git remote set-url origin https://x-access-token:${{ secrets.PAT }}@github.com/${{ github.repository }}.git

      - name: Prepare Muma folder and cleanup
        run: |
          mkdir -p Muma
          rm -rf Muma/*
          rm -f muma mumab64

      - name: Clone upstream trojan repo to temp folder
        run: |
          git clone --depth=1 https://github.com/suiyuan8/trojan temp-trojan

      - name: Copy files to Muma folder
        run: |
          cp -r temp-trojan/* Muma/
          rm -rf temp-trojan

      - name: Check Muma folder has files
        run: |
          if [ -z "$(ls -A Muma)" ]; then
            echo "Muma folder is empty. Exiting."
            exit 1
          fi

      - name: Merge all files into single muma file in root
        run: |
          : > muma
          find Muma -type f | sort | while read -r file; do
            if [ -s "$file" ]; then
              last_char=$(tail -c 1 "$file")
              if [ "$last_char" = "" ]; then
                cat "$file" >> muma
              else
                cat "$file" >> muma
                echo "" >> muma
              fi
            fi
          done

      - name: Rename nodes with _序号 after region, discard旧后缀
        run: |
          total=$(grep -E '^(trojan|vless|ss|ssr|trojan-go|trojan-ws):\/\/|^[[:space:]]*name:' muma | wc -l)
          if (( total <= 9 )); then width=1; elif (( total <= 99 )); then width=2; else width=3; fi

          awk -v width="$width" '
          function pad(n, w) {
            fmt = "%0" w "d"
            return sprintf(fmt, n)
          }
          function replace_region(region) {
            gsub(/%F0%9F%87%A8%F0%9F%87%B3TW/, "%F0%9F%87%B9%F0%9F%87%BCTW", region)
            gsub(/🇨🇳TW/, "🇹🇼TW", region)
            return region
          }
          function extract_region(name) {
            if (match(name, /^([^_ ]+TW)/, arr)) {
              return arr[1]
            } else {
              return name
            }
          }
          BEGIN { count=1 }
          {
            line = $0
            if (match(line, /^(trojan|vless|ss|ssr|trojan-go|trojan-ws):\/\//)) {
              if (match(line, /#.*$/)) {
                orig = substr(line, RSTART+1)
                region = replace_region(extract_region(orig))
                seq = pad(count, width)
                newname = region "_" seq
                sub(/#.*$/, "#" newname, line)
                count++
              }
              print line
            } else if (match(line, /^[[:space:]]*name:[[:space:]]*/)) {
              origname = substr(line, index(line, "name:") + 5)
              gsub(/^ */, "", origname)
              gsub(/ *$/, "", origname)
              region = replace_region(extract_region(origname))
              seq = pad(count, width)
              newname = region "_" seq
              sub(/name:.*/, "name: " newname, line)
              count++
              print line
            } else {
              print line
            }
          }
          ' muma > muma_renamed
          mv muma_renamed muma

      - name: Generate Base64 encoded file as mumab64 (no line breaks)
        run: |
          if [ -s muma ]; then
            base64 -w 0 muma > mumab64
          else
            : > mumab64
          fi

      - name: Commit and push changes
        run: |
          git add Muma muma mumab64
          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Sync Muma folder, rename nodes, update merged muma file and Base64 encoded mumab64"
            git push origin main
